# ---------------------------
# REDIRECTION HTTP → HTTPS
# ---------------------------
server {
    listen 80;
    server_name miabesite.site *.miabesite.site;

    # Redirige toutes les requêtes HTTP vers HTTPS
    return 301 https://$host$request_uri;
}

# ---------------------------
# SERVEUR PRINCIPAL + SOUS-DOMAINES
# ---------------------------
server {
    listen 443 ssl http2;
    server_name miabesite.site *.miabesite.site;

    # ---------------------------
    # SSL CONFIGURATION
    # ---------------------------
    ssl_certificate /etc/letsencrypt/live/miabesite.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/miabesite.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # ---------------------------
    # PERFORMANCE & SÉCURITÉ
    # ---------------------------
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # ---------------------------
    # CACHE NGINX (Optionnel mais utile)
    # ---------------------------
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=miabe_cache:10m inactive=60m;
    proxy_cache_key "$scheme$request_method$host$request_uri";

    # ---------------------------
    # FICHIERS STATIQUES
    # ---------------------------
    location /static {
        alias /var/www/miabesite/app/static;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ---------------------------
    # APPLICATION FLASK (TOUS SOUS-DOMAINES)
    # ---------------------------
    location / {
        proxy_cache miabe_cache;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404 1m;
        add_header X-Cache-Status $upstream_cache_status;

        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ---------------------------
    # LOGS
    # ---------------------------
    access_log /var/log/nginx/miabesite_access.log;
    error_log  /var/log/nginx/miabesite_error.log;
}
